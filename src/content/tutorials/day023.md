---
day: Day 23
title: L-Systemã§ç”Ÿæˆã™ã‚‹ç«‹ä½“çš„ãªæœ¨æ§‹é€ 
difficulty: 4.5
tags: [lsystem, tree, 3d, branching, pipe, recursive]
---

## âœ… Inputs

- axiom: str â€“ åˆæœŸæ–‡å­—åˆ—ï¼ˆä¾‹: `"F"`ï¼‰
- rules: dict â€“ æ›¸ãæ›ãˆãƒ«ãƒ¼ãƒ«ï¼ˆä¾‹: `{"F": "F[+F][-F][^F][&F][\\F][/F]"}`ï¼‰
- angle: float â€“ å„å›è»¢ã®è§’åº¦ï¼ˆåº¦ï¼‰
- base_length: float â€“ åˆæœŸã®æã®é•·ã•
- depth: int â€“ ãƒ«ãƒ¼ãƒ«å±•é–‹ã®åå¾©å›æ•°ï¼ˆå†å¸°æ·±åº¦ï¼‰
- decay: float â€“ å„åˆ†å²ã§æãŒçŸ­ããªã‚‹æ¯”ç‡ï¼ˆ0.8 ãªã©ï¼‰
- pipe_radius: float â€“ Pipeã®å¤ªã•

## âœ… Outputs

- results: list of Brep â€“ 3Dç©ºé–“ã«ç«‹ä½“çš„ã«åˆ†å²ã™ã‚‹L-Systemæ§‹é€ ã‚’Pipeã§å¯è¦–åŒ–ã—ãŸã‚‚ã®

## âœ… Code

```python
import Rhino.Geometry as rg
import math

# === ğŸ”§ å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¾‹ï¼ˆå…¨æ–¹å‘ã¸ã®åˆ†å²ï¼‰
axiom = "F"
rules = {
    "F": "F[+F][-F][^F][&F][\\F][/F]"  # å…¨æ–¹å‘ã¸ãƒãƒ©ãƒ³ã‚¹ã‚ˆãåˆ†å²
}
angle = 40.0         # å›è»¢è§’åº¦ï¼ˆåº¦ï¼‰
base_length = 100.0   # åˆæœŸæã®é•·ã•
depth = 4            # å†å¸°æ·±åº¦
decay = 0.8          # æã®é•·ã•æ¸›è¡°ç‡
pipe_radius = 1.0

# === ğŸ§¬ L-Systemã®å±•é–‹
def expand_lsystem(axiom, rules, depth):
    result = axiom
    for _ in range(depth):
        next_result = ""
        for char in result:
            next_result += rules.get(char, char)
        result = next_result
    return result

# === ğŸ¢ Turtleæç”»ï¼ˆ3D Turtle with Length Decayï¼‰
def interpret_lsystem(lsys_string, angle_deg, base_length, decay):
    pos_stack = []
    dir_stack = []
    up_stack = []
    right_stack = []
    length_stack = []

    pos = rg.Point3d(0, 0, 0)
    dir = rg.Vector3d(0, 0, 1)     # Zæ–¹å‘ã«ä¼¸ã³ã‚‹
    up = rg.Vector3d(1, 0, 0)      # Xè»¸æ–¹å‘
    right = rg.Vector3d(0, 1, 0)   # Yè»¸æ–¹å‘
    length = base_length

    lines = []
    angle_rad = math.radians(angle_deg)

    for char in lsys_string:
        if char == "F":
            new_pos = pos + dir * length
            lines.append(rg.Line(pos, new_pos))
            pos = new_pos
        elif char == "+":
            xform = rg.Transform.Rotation(angle_rad, up, pos)
            dir.Transform(xform)
        elif char == "-":
            xform = rg.Transform.Rotation(-angle_rad, up, pos)
            dir.Transform(xform)
        elif char == "&":
            xform = rg.Transform.Rotation(angle_rad, right, pos)
            dir.Transform(xform)
        elif char == "^":
            xform = rg.Transform.Rotation(-angle_rad, right, pos)
            dir.Transform(xform)
        elif char == "\\":
            xform = rg.Transform.Rotation(angle_rad, dir, pos)
            up.Transform(xform)
            right.Transform(xform)
        elif char == "/":
            xform = rg.Transform.Rotation(-angle_rad, dir, pos)
            up.Transform(xform)
            right.Transform(xform)
        elif char == "[":
            pos_stack.append(rg.Point3d(pos))
            dir_stack.append(rg.Vector3d(dir))
            up_stack.append(rg.Vector3d(up))
            right_stack.append(rg.Vector3d(right))
            length_stack.append(length)
            length *= decay  # æã‚’çŸ­ãã™ã‚‹
        elif char == "]":
            pos = pos_stack.pop()
            dir = dir_stack.pop()
            up = up_stack.pop()
            right = right_stack.pop()
            length = length_stack.pop()

    return [l.ToNurbsCurve() for l in lines]

# === ğŸš€ å®Ÿè¡Œ
lsys_string = expand_lsystem(axiom, rules, depth)
curves = interpret_lsystem(lsys_string, angle, base_length, decay)

results = []
for c in curves:
    pipes = rg.Brep.CreatePipe(c, pipe_radius, False, rg.PipeCapMode.Round, True, 0.001, 0.001)
    if pipes:
        results.extend(pipes)
```